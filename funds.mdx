# Funding Fee Implementation Plan (One-Day Sprint)

## Database Changes

1. Add to trading_positions table:

   - last_funding_time TIMESTAMPTZ
   - cumulative_funding_fee DECIMAL

2. Create new funding_rates table:
   - id UUID PRIMARY KEY
   - symbol TEXT
   - funding_rate DECIMAL
   - next_funding_time TIMESTAMPTZ
   - created_at TIMESTAMPTZ DEFAULT NOW()

## Backend Implementation

1. Binance API Integration

   - Endpoint: https://fapi.binance.com/fapi/v1/premiumIndex
   - Fetch current funding rates for all supported trading pairs
   - Store in funding_rates table

2. Funding Calculation Service

   - Formula: funding_fee = position_size × funding_rate
   - Positive rate: longs pay shorts
   - Negative rate: shorts pay longs
   - Update position with cumulative fees
   - Update user virtual currency balance

3. Scheduled Tasks
   - Fetch funding rates hourly
   - Process funding payments at 00:00, 08:00, 16:00 UTC
   - Add manual trigger for testing

## Frontend Updates

1. Trading Interface

   - Display current funding rate near the trading pair
   - Show countdown timer to next funding event
   - Add estimated funding fee to position details

2. Position Display
   - Include paid/received funding fees in position details
   - Update PnL calculation to include funding fees

## Testing Priorities

1. Verify funding rate retrieval from Binance
2. Test calculation with sample positions:
   - Long position with positive rate
   - Short position with negative rate
3. Test scheduled execution
4. Verify balance updates after funding event

## Fallback Plan (If Running Out of Time)

1. Use fixed hardcoded funding rates (±0.01%)
2. Implement basic calculation without all UI elements
3. Add simple text indicator for current funding rate
4. Schedule only the core calculation job

## Implementation Order

1. Database changes (30 min)
2. Binance API integration (45 min)
3. Funding calculation logic (90 min)
4. Scheduled tasks (60 min)
5. Basic UI changes (90 min)
6. Testing (45 min)
7. Deployment (30 min)

## Post-Implementation Tasks (For Later)

1. Add comprehensive error handling
2. Implement historical funding rate display
3. Create funding payment history view
4. Add more detailed analytics and reporting
5. Optimize performance for large numbers of positions
